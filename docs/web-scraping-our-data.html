<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Web Scraping Our Data | Telfer 2020 Directed Reading: Natural Language Processing</title>
  <meta name="description" content="This is Christopher Belanger’s work product for the Telfer School of Management course MBA6292, Directed Readings in Natural Language Processing." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Web Scraping Our Data | Telfer 2020 Directed Reading: Natural Language Processing" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is Christopher Belanger’s work product for the Telfer School of Management course MBA6292, Directed Readings in Natural Language Processing." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Web Scraping Our Data | Telfer 2020 Directed Reading: Natural Language Processing" />
  
  <meta name="twitter:description" content="This is Christopher Belanger’s work product for the Telfer School of Management course MBA6292, Directed Readings in Natural Language Processing." />
  

<meta name="author" content="Christopher Belanger" />


<meta name="date" content="2020-12-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="data-summary-eda-initial-model-attempts.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">MBA6292: Directed Readings in NLP</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html"><i class="fa fa-check"></i><b>3</b> Web Scraping Our Data</a><ul>
<li class="chapter" data-level="3.1" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#foreword-ethics"><i class="fa fa-check"></i><b>3.1</b> Foreword: Ethics</a></li>
<li class="chapter" data-level="3.2" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#the-general-idea"><i class="fa fa-check"></i><b>3.2</b> The General Idea</a></li>
<li class="chapter" data-level="3.3" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#goodreads-css-selectors"><i class="fa fa-check"></i><b>3.3</b> Goodreads: CSS Selectors</a><ul>
<li class="chapter" data-level="3.3.1" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#scraping-the-index"><i class="fa fa-check"></i><b>3.3.1</b> Scraping the Index</a></li>
<li class="chapter" data-level="3.3.2" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#scraping-the-content"><i class="fa fa-check"></i><b>3.3.2</b> Scraping the Content</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#yelp-embedded-json"><i class="fa fa-check"></i><b>3.4</b> Yelp: Embedded JSON</a><ul>
<li class="chapter" data-level="3.4.1" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#scraping-the-index-1"><i class="fa fa-check"></i><b>3.4.1</b> Scraping the Index</a></li>
<li class="chapter" data-level="3.4.2" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#scraping-the-content-1"><i class="fa fa-check"></i><b>3.4.2</b> Scraping the Content</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#mec-reverse-engineering-client-side-api-calls"><i class="fa fa-check"></i><b>3.5</b> MEC: Reverse-Engineering Client-Side API Calls</a><ul>
<li class="chapter" data-level="3.5.1" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#scraping-the-index-2"><i class="fa fa-check"></i><b>3.5.1</b> Scraping the Index</a></li>
<li class="chapter" data-level="3.5.2" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#functions-for-api-calls"><i class="fa fa-check"></i><b>3.5.2</b> Functions for API Calls</a></li>
<li class="chapter" data-level="3.5.3" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#scraping-the-content-2"><i class="fa fa-check"></i><b>3.5.3</b> Scraping the Content</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="web-scraping-our-data.html"><a href="web-scraping-our-data.html#summary"><i class="fa fa-check"></i><b>3.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html"><i class="fa fa-check"></i><b>4</b> Data Summary, EDA, &amp; Initial Model Attempts</a><ul>
<li class="chapter" data-level="4.1" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#goodreads"><i class="fa fa-check"></i><b>4.2</b> Goodreads</a><ul>
<li class="chapter" data-level="4.2.1" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#star-ratings"><i class="fa fa-check"></i><b>4.2.1</b> Star Ratings</a></li>
<li class="chapter" data-level="4.2.2" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#word-count"><i class="fa fa-check"></i><b>4.2.2</b> Word Count</a></li>
<li class="chapter" data-level="4.2.3" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#reviewers"><i class="fa fa-check"></i><b>4.2.3</b> Reviewers</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#yelp"><i class="fa fa-check"></i><b>4.3</b> Yelp</a><ul>
<li class="chapter" data-level="4.3.1" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#star-ratings-1"><i class="fa fa-check"></i><b>4.3.1</b> Star Ratings</a></li>
<li class="chapter" data-level="4.3.2" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#word-count-1"><i class="fa fa-check"></i><b>4.3.2</b> Word Count</a></li>
<li class="chapter" data-level="4.3.3" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#reviewers-1"><i class="fa fa-check"></i><b>4.3.3</b> Reviewers</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#mountain-equipment-co-op-mec"><i class="fa fa-check"></i><b>4.4</b> Mountain Equipment Co-op (MEC)</a><ul>
<li class="chapter" data-level="4.4.1" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#star-ratings-2"><i class="fa fa-check"></i><b>4.4.1</b> Star Ratings</a></li>
<li class="chapter" data-level="4.4.2" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#word-counts"><i class="fa fa-check"></i><b>4.4.2</b> Word Counts</a></li>
<li class="chapter" data-level="4.4.3" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#reviewers-2"><i class="fa fa-check"></i><b>4.4.3</b> Reviewers</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#comparing-goodreads-mec-and-yelp"><i class="fa fa-check"></i><b>4.5</b> Comparing Goodreads, MEC, and Yelp</a><ul>
<li class="chapter" data-level="4.5.1" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#star-ratings-3"><i class="fa fa-check"></i><b>4.5.1</b> Star Ratings</a></li>
<li class="chapter" data-level="4.5.2" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#word-counts-1"><i class="fa fa-check"></i><b>4.5.2</b> Word Counts</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#reviews-over-time"><i class="fa fa-check"></i><b>4.6</b> Reviews Over Time</a><ul>
<li class="chapter" data-level="4.6.1" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#goodreads-1"><i class="fa fa-check"></i><b>4.6.1</b> Goodreads</a></li>
<li class="chapter" data-level="4.6.2" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#yelp-1"><i class="fa fa-check"></i><b>4.6.2</b> Yelp</a></li>
<li class="chapter" data-level="4.6.3" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#mec"><i class="fa fa-check"></i><b>4.6.3</b> MEC</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#proposed-next-steps"><i class="fa fa-check"></i><b>4.7</b> Proposed Next Steps</a></li>
<li class="chapter" data-level="4.8" data-path="data-summary-eda-initial-model-attempts.html"><a href="data-summary-eda-initial-model-attempts.html#sessioninfo"><i class="fa fa-check"></i><b>4.8</b> SessionInfo</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html"><i class="fa fa-check"></i><b>5</b> A First LASSO Attempt</a><ul>
<li class="chapter" data-level="5.1" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#introduction-1"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#a-first-regression-yelp-data"><i class="fa fa-check"></i><b>5.2</b> A First Regression: Yelp Data</a><ul>
<li class="chapter" data-level="5.2.1" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#splitting-the-data"><i class="fa fa-check"></i><b>5.2.1</b> Splitting the data</a></li>
<li class="chapter" data-level="5.2.2" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#evaluating-the-first-model"><i class="fa fa-check"></i><b>5.2.2</b> Evaluating the first model</a></li>
<li class="chapter" data-level="5.2.3" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#tuning-model-parameters"><i class="fa fa-check"></i><b>5.2.3</b> Tuning model parameters</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#trying-lasso-again"><i class="fa fa-check"></i><b>5.3</b> Trying lasso again</a><ul>
<li class="chapter" data-level="5.3.1" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#with-1000-tokens"><i class="fa fa-check"></i><b>5.3.1</b> With 1000 tokens</a></li>
<li class="chapter" data-level="5.3.2" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#short-reviews-only-125-words"><i class="fa fa-check"></i><b>5.3.2</b> Short reviews only: &lt;125 words</a></li>
<li class="chapter" data-level="5.3.3" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#longer-reviews-125-words"><i class="fa fa-check"></i><b>5.3.3</b> Longer reviews &gt; 125 words</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#removing-stop-words"><i class="fa fa-check"></i><b>5.4</b> Removing stop words</a></li>
<li class="chapter" data-level="5.5" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#adjusting-n-grams"><i class="fa fa-check"></i><b>5.5</b> Adjusting n-grams</a></li>
<li class="chapter" data-level="5.6" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#full-final-regression"><i class="fa fa-check"></i><b>5.6</b> Full final regression</a></li>
<li class="chapter" data-level="5.7" data-path="a-first-lasso-attempt.html"><a href="a-first-lasso-attempt.html#conclusion"><i class="fa fa-check"></i><b>5.7</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html"><i class="fa fa-check"></i><b>6</b> Yelp Classification and Sentiment Test</a><ul>
<li class="chapter" data-level="6.1" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#yelp-dataset"><i class="fa fa-check"></i><b>6.1</b> Yelp Dataset</a><ul>
<li class="chapter" data-level="6.1.1" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#afinn"><i class="fa fa-check"></i><b>6.1.1</b> AFINN</a></li>
<li class="chapter" data-level="6.1.2" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#classification-naive-bayes-classifier"><i class="fa fa-check"></i><b>6.1.2</b> Classification: Naive Bayes Classifier</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#kaggle-yelp-dataset"><i class="fa fa-check"></i><b>6.2</b> Kaggle Yelp dataset</a><ul>
<li class="chapter" data-level="6.2.1" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#naive-bayes-classifier"><i class="fa fa-check"></i><b>6.2.1</b> Naive Bayes Classifier</a></li>
<li class="chapter" data-level="6.2.2" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#logistic-regression"><i class="fa fa-check"></i><b>6.2.2</b> Logistic Regression</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#next-steps"><i class="fa fa-check"></i><b>6.3</b> NEXT STEPS</a></li>
<li class="chapter" data-level="6.4" data-path="yelp-classification-and-sentiment-test.html"><a href="yelp-classification-and-sentiment-test.html#sessioninfo-1"><i class="fa fa-check"></i><b>6.4</b> SessionInfo</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><i class="fa fa-check"></i><b>7</b> The MVP: Classification Accuracy as a Function of Review Length and Volume</a><ul>
<li class="chapter" data-level="7.1" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#introduction-2"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#preparing-the-data"><i class="fa fa-check"></i><b>7.2</b> Preparing the Data</a></li>
<li class="chapter" data-level="7.3" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#experiment-1-logistic-regression-on-globally-balanced-data"><i class="fa fa-check"></i><b>7.3</b> Experiment 1: Logistic Regression on Globally Balanced Data</a></li>
<li class="chapter" data-level="7.4" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#experiment-2-logistic-regression-on-micro-balanced-data"><i class="fa fa-check"></i><b>7.4</b> Experiment 2: Logistic Regression on Micro-Balanced Data</a></li>
<li class="chapter" data-level="7.5" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#conclusions"><i class="fa fa-check"></i><b>7.5</b> Conclusions</a></li>
<li class="chapter" data-level="7.6" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#next-steps-1"><i class="fa fa-check"></i><b>7.6</b> Next Steps</a></li>
<li class="chapter" data-level="7.7" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#sessioninfo-2"><i class="fa fa-check"></i><b>7.7</b> SessionInfo</a></li>
<li class="chapter" data-level="7.8" data-path="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html"><a href="the-mvp-classification-accuracy-as-a-function-of-review-length-and-volume.html#references"><i class="fa fa-check"></i><b>7.8</b> References</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html"><i class="fa fa-check"></i><b>8</b> Beyond the MVP: Looking at Longer Reviews</a><ul>
<li class="chapter" data-level="8.1" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#introduction-3"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#results-from-the-previous-section"><i class="fa fa-check"></i><b>8.2</b> Results from the Previous Section</a></li>
<li class="chapter" data-level="8.3" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#finding-misclassified-reviews"><i class="fa fa-check"></i><b>8.3</b> Finding Misclassified Reviews</a></li>
<li class="chapter" data-level="8.4" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#qualitative-analysis-of-misclassified-reviews"><i class="fa fa-check"></i><b>8.4</b> Qualitative Analysis of Misclassified Reviews</a></li>
<li class="chapter" data-level="8.5" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#negations"><i class="fa fa-check"></i><b>8.5</b> Negations</a><ul>
<li class="chapter" data-level="8.5.1" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#negations-and-prediction-accuracy"><i class="fa fa-check"></i><b>8.5.1</b> Negations and Prediction Accuracy</a></li>
<li class="chapter" data-level="8.5.2" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#negations-and-word-length"><i class="fa fa-check"></i><b>8.5.2</b> Negations and Word Length</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#readability"><i class="fa fa-check"></i><b>8.6</b> Readability</a></li>
<li class="chapter" data-level="8.7" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#summing-up-so-far"><i class="fa fa-check"></i><b>8.7</b> Summing Up So Far</a></li>
<li class="chapter" data-level="8.8" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#logistic-regression-on-afinn-negators"><i class="fa fa-check"></i><b>8.8</b> Logistic Regression on AFINN + negators</a></li>
<li class="chapter" data-level="8.9" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#logistic-regression-on-mean-afinn-negators"><i class="fa fa-check"></i><b>8.9</b> Logistic Regression on Mean AFINN + negators</a></li>
<li class="chapter" data-level="8.10" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#comparing-models-multiple-trials"><i class="fa fa-check"></i><b>8.10</b> Comparing Models: Multiple Trials</a></li>
<li class="chapter" data-level="8.11" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#re-running-the-big-analysis"><i class="fa fa-check"></i><b>8.11</b> Re-Running the Big Analysis</a></li>
<li class="chapter" data-level="8.12" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#conclusion-1"><i class="fa fa-check"></i><b>8.12</b> Conclusion</a></li>
<li class="chapter" data-level="8.13" data-path="beyond-the-mvp-looking-at-longer-reviews.html"><a href="beyond-the-mvp-looking-at-longer-reviews.html#sessioninfo-3"><i class="fa fa-check"></i><b>8.13</b> SessionInfo</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html"><i class="fa fa-check"></i><b>9</b> Beyond the MVP: Support Vector Machine Classification</a><ul>
<li class="chapter" data-level="9.1" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#introduction-4"><i class="fa fa-check"></i><b>9.1</b> Introduction</a></li>
<li class="chapter" data-level="9.2" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#svm-classifiers"><i class="fa fa-check"></i><b>9.2</b> SVM Classifiers</a></li>
<li class="chapter" data-level="9.3" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#preparing-the-data-1"><i class="fa fa-check"></i><b>9.3</b> Preparing the Data</a></li>
<li class="chapter" data-level="9.4" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#svm-classification"><i class="fa fa-check"></i><b>9.4</b> SVM Classification</a></li>
<li class="chapter" data-level="9.5" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#predicting-with-last_fit"><i class="fa fa-check"></i><b>9.5</b> Predicting with <code>last_fit()</code></a></li>
<li class="chapter" data-level="9.6" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#fitting-and-predicting-using-fit"><i class="fa fa-check"></i><b>9.6</b> Fitting and Predicting Using <code>fit()</code></a></li>
<li class="chapter" data-level="9.7" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#conclusions-1"><i class="fa fa-check"></i><b>9.7</b> Conclusions</a></li>
<li class="chapter" data-level="9.8" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#sessioninfo-4"><i class="fa fa-check"></i><b>9.8</b> SessionInfo</a></li>
<li class="chapter" data-level="9.9" data-path="beyond-the-mvp-support-vector-machine-classification.html"><a href="beyond-the-mvp-support-vector-machine-classification.html#references-1"><i class="fa fa-check"></i><b>9.9</b> References</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html"><i class="fa fa-check"></i><b>10</b> Building a Shiny App</a><ul>
<li class="chapter" data-level="10.1" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html#the-app"><i class="fa fa-check"></i><b>10.1</b> The App!</a></li>
<li class="chapter" data-level="10.2" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html#exporting-our-models"><i class="fa fa-check"></i><b>10.2</b> Exporting Our Models</a></li>
<li class="chapter" data-level="10.3" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html#prepping-and-testing-our-models"><i class="fa fa-check"></i><b>10.3</b> Prepping and Testing Our Models</a></li>
<li class="chapter" data-level="10.4" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html#saving-the-data"><i class="fa fa-check"></i><b>10.4</b> Saving the Data</a></li>
<li class="chapter" data-level="10.5" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html#the-logic-of-the-app"><i class="fa fa-check"></i><b>10.5</b> The Logic of the App</a></li>
<li class="chapter" data-level="10.6" data-path="building-a-shiny-app.html"><a href="building-a-shiny-app.html#putting-it-all-together"><i class="fa fa-check"></i><b>10.6</b> Putting it All Together</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-2.html"><a href="references-2.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Telfer 2020 Directed Reading: Natural Language Processing</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="web-scraping-our-data" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Web Scraping Our Data</h1>
<p>In this section I will discuss ethical concerns related to web scraping and describe three different approaches I used to scrape datasets from Yelp, Goodreads, and MEC.</p>
<div id="foreword-ethics" class="section level2">
<h2><span class="header-section-number">3.1</span> Foreword: Ethics</h2>
<p>I this section I will briefly consider some ethical aspects of web scraping. Although it’s a rich topic, my treatment here will be superficial and my conclusion will be that this project is fine.</p>
<p>What is web scraping? As a working definition, let’s say that web scraping–which can also be called crawling, trawling, indexing, harvesting, or any number of other terms–means automatically visiting websites to collect and store information. So at one extreme, browsing Facebook at work doesn’t count since it’s not automatic. On the other extreme, automatically sending billions of requests to a server in an attempt to overload (i.e. a DDoS attack) doesn’t count either, since nothing is being done with the information the server sends back.</p>
<p>Why might web scraping be wrong? Here I’ll consider three potential objections based on access, burdening the scrapee, and purpose, and show how I’ve designed this project to mitigate those concerns.</p>
<p>Web scraping might be wrong if we’re taking things we’re not supposed to have access to. For example, if data were held on a password-protected server, one might think it wrong to collect it all automatically and re-create that dataset elsewhere. To mitigate this concern, we will only scrape publicly accessible data.</p>
<p>Web scraping might be wrong if it posed an undue burden on the sites we’re scraping. For example, if we were to scrape millions of pages or records from a single site in a short time, it might overload their servers or disrupt other people’s access. To mitigate this concern, we can scrape a smallish number of pages and spread our requests out so that we don’t overload any servers.</p>
<p>Web scraping might be wrong if we were to use the data we collect unethically. As an example, one might think it would be unethical to scrape data and use it for political or financial purposes. To mitigate this concern, we will only use the data we collect for non-commercial educational purposes.</p>
<p>Note also that web scraping is an extremely common business model. To take an obvious example, Google’s entire search business is based on information it has extracted from websites–in other words, web scraping <span class="citation">(Google <a href="#ref-google_how_2020" role="doc-biblioref">2020</a>)</span>. Beyond Google, news agencies report that between 30% and 50% of all web traffic may be from automated web-scraping bots <span class="citation">(Bruell <a href="#ref-bruell_fraudulent_2018" role="doc-biblioref">2018</a>; LaFrance <a href="#ref-lafrance_internet_2017" role="doc-biblioref">2017</a>)</span>. And programming languages, including R, ship with packages that make web scraping relatively easy <span class="citation">(Wickham <a href="#ref-wickham_package_2020" role="doc-biblioref">2020</a>)</span>. So we can say at least that in some cases, web scraping on a massive scale is a commonly accepted business practice.</p>
<p>In summary, in this project I’ve made the following choices to mitigate ethical concerns about web scraping:</p>
<ul>
<li>We’re only scraping publicly accessible information;</li>
<li>We’re scraping a reasonably small number of pages/reviews;</li>
<li>We’re being considerate of their servers by spacing out our requests; and,</li>
<li>We’re collecting and using the data for educational non-commercial purposes.</li>
</ul>
</div>
<div id="the-general-idea" class="section level2">
<h2><span class="header-section-number">3.2</span> The General Idea</h2>
<p>Web scraping these sites follows a two-step process:</p>
<ol style="list-style-type: decimal">
<li>Get a list of urls for pages you want to scrape (generating an <em>index</em>).</li>
</ol>
<ul>
<li>Usually we’ll get these urls by first scraping another page.</li>
</ul>
<ol style="list-style-type: decimal">
<li>Use a loop to scrape the information from each page (loading the <em>content</em>).</li>
</ol>
<p>Since different sites have different structures, we’ll need custom code for the index and content pages. Also, by random chance these three sites all use different web-design principles, so we’ll also need to use different techniques.</p>
</div>
<div id="goodreads-css-selectors" class="section level2">
<h2><span class="header-section-number">3.3</span> Goodreads: CSS Selectors</h2>
<p><a href="www.goodreads.com">Goodreads</a> describes itself as “the world’s largest site for readers and book recommendations” (<span class="citation">Goodreads (<a href="#ref-goodreads_about_2020" role="doc-biblioref">2020</a>)</span>). Registered users can leave reviews and ratings for books, any anyone can use the site to browse user-submitted reviews and a variety of information about books.</p>
<p>Goodreads’ pages are standard html, so we can use css selectors to isolate the exact parts of the page we’re interested in. I used R’s <strong>rvest</strong> package, and the package documentation has details about the methods and about css selectors in general <span class="citation">(Wickham <a href="#ref-wickham_package_2020" role="doc-biblioref">2020</a>)</span>. To find the css selectors I used <a href="https://selectorgadget.com/">SelectorGadget</a>, a point-and-click Chrome extension.</p>
<div id="scraping-the-index" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Scraping the Index</h3>
<p>Goodreads assigns books to genres like “sci-fi” and “romance,” and curates lists of each genre’s 100 most-read books in the past week. By scraping these pages, we can get links to content pages for hundreds of books across different genres.</p>
<p>Here is a code block to get the links to the 100 most-read books in the “classics” genre. The code could be functionized or run several times for other genres.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="web-scraping-our-data.html#cb1-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="web-scraping-our-data.html#cb1-2"></a><span class="kw">library</span>(rvest)</span>
<span id="cb1-3"><a href="web-scraping-our-data.html#cb1-3"></a></span>
<span id="cb1-4"><a href="web-scraping-our-data.html#cb1-4"></a><span class="co"># choose a genre</span></span>
<span id="cb1-5"><a href="web-scraping-our-data.html#cb1-5"></a>genre &lt;-<span class="st"> &quot;classics&quot;</span></span>
<span id="cb1-6"><a href="web-scraping-our-data.html#cb1-6"></a></span>
<span id="cb1-7"><a href="web-scraping-our-data.html#cb1-7"></a>url &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;https://www.goodreads.com/genres/most_read/&quot;</span>,genre)</span>
<span id="cb1-8"><a href="web-scraping-our-data.html#cb1-8"></a></span>
<span id="cb1-9"><a href="web-scraping-our-data.html#cb1-9"></a><span class="co"># read the page</span></span>
<span id="cb1-10"><a href="web-scraping-our-data.html#cb1-10"></a>page &lt;-<span class="st"> </span><span class="kw">read_html</span>(url)</span>
<span id="cb1-11"><a href="web-scraping-our-data.html#cb1-11"></a></span>
<span id="cb1-12"><a href="web-scraping-our-data.html#cb1-12"></a><span class="co"># extract the links to each book&#39;s page using css selectors</span></span>
<span id="cb1-13"><a href="web-scraping-our-data.html#cb1-13"></a>book_links &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb1-14"><a href="web-scraping-our-data.html#cb1-14"></a><span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&quot;.coverWrapper&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1-15"><a href="web-scraping-our-data.html#cb1-15"></a><span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&quot;a&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1-16"><a href="web-scraping-our-data.html#cb1-16"></a><span class="st">  </span><span class="kw">html_attr</span>(<span class="st">&quot;href&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1-17"><a href="web-scraping-our-data.html#cb1-17"></a><span class="st">  </span><span class="kw">paste0</span>(<span class="st">&quot;https://www.goodreads.com&quot;</span>, .)</span>
<span id="cb1-18"><a href="web-scraping-our-data.html#cb1-18"></a></span>
<span id="cb1-19"><a href="web-scraping-our-data.html#cb1-19"></a>book_links <span class="op">%&gt;%</span></span>
<span id="cb1-20"><a href="web-scraping-our-data.html#cb1-20"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb1-21"><a href="web-scraping-our-data.html#cb1-21"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="kw">paste0</span>(<span class="st">&quot;book_links_&quot;</span>,genre,<span class="st">&quot;.csv&quot;</span>))</span></code></pre></div>
</div>
<div id="scraping-the-content" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Scraping the Content</h3>
<p>The next step is to load each content link and extract the information about the book, its author, and all the reviews. Books can have several pages of reviews, so we need to figure out how mayn pages there are and how to crawl through them. Since not all reviews have both text and star ratings, we also need to be careful to make sure we handle missing data appropriately.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="web-scraping-our-data.html#cb2-1"></a><span class="co">#https://www.goodreads.com/genres/most_read/non-fiction</span></span>
<span id="cb2-2"><a href="web-scraping-our-data.html#cb2-2"></a>links &lt;-<span class="st"> </span>book_links</span>
<span id="cb2-3"><a href="web-scraping-our-data.html#cb2-3"></a></span>
<span id="cb2-4"><a href="web-scraping-our-data.html#cb2-4"></a><span class="co"># set up empty results tibble</span></span>
<span id="cb2-5"><a href="web-scraping-our-data.html#cb2-5"></a>results &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb2-6"><a href="web-scraping-our-data.html#cb2-6"></a></span>
<span id="cb2-7"><a href="web-scraping-our-data.html#cb2-7"></a><span class="co"># remove any links we&#39;ve already seen, if we crashed and are resuming</span></span>
<span id="cb2-8"><a href="web-scraping-our-data.html#cb2-8"></a>links &lt;-<span class="st"> </span>links[<span class="op">!</span>links <span class="op">%in%</span><span class="st"> </span>results<span class="op">$</span>url]</span>
<span id="cb2-9"><a href="web-scraping-our-data.html#cb2-9"></a></span>
<span id="cb2-10"><a href="web-scraping-our-data.html#cb2-10"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(links)) {</span>
<span id="cb2-11"><a href="web-scraping-our-data.html#cb2-11"></a>  </span>
<span id="cb2-12"><a href="web-scraping-our-data.html#cb2-12"></a>  <span class="co"># pause briefly</span></span>
<span id="cb2-13"><a href="web-scraping-our-data.html#cb2-13"></a>  <span class="kw">pause</span>()</span>
<span id="cb2-14"><a href="web-scraping-our-data.html#cb2-14"></a>  </span>
<span id="cb2-15"><a href="web-scraping-our-data.html#cb2-15"></a>  <span class="co"># get the url we&#39;re interested in</span></span>
<span id="cb2-16"><a href="web-scraping-our-data.html#cb2-16"></a>  url &lt;-<span class="st"> </span>links[[i]]</span>
<span id="cb2-17"><a href="web-scraping-our-data.html#cb2-17"></a>  </span>
<span id="cb2-18"><a href="web-scraping-our-data.html#cb2-18"></a>  </span>
<span id="cb2-19"><a href="web-scraping-our-data.html#cb2-19"></a>  <span class="co"># write an update, since I&#39;m impatient and want to know what&#39;s happening</span></span>
<span id="cb2-20"><a href="web-scraping-our-data.html#cb2-20"></a>  <span class="kw">message</span>(<span class="kw">paste0</span>(i,<span class="st">&quot;/&quot;</span>,<span class="kw">length</span>(links),<span class="st">&quot;: &quot;</span>, url))</span>
<span id="cb2-21"><a href="web-scraping-our-data.html#cb2-21"></a>  </span>
<span id="cb2-22"><a href="web-scraping-our-data.html#cb2-22"></a>  <span class="co"># choose a random useragent each time we load the page -- anti-anti-scraping measure</span></span>
<span id="cb2-23"><a href="web-scraping-our-data.html#cb2-23"></a>  httr<span class="op">::</span><span class="kw">user_agent</span>(<span class="kw">random_useragent</span>()) <span class="op">%&gt;%</span></span>
<span id="cb2-24"><a href="web-scraping-our-data.html#cb2-24"></a><span class="st">    </span>httr<span class="op">::</span><span class="kw">set_config</span>()</span>
<span id="cb2-25"><a href="web-scraping-our-data.html#cb2-25"></a>  <span class="co"># read the url</span></span>
<span id="cb2-26"><a href="web-scraping-our-data.html#cb2-26"></a>  </span>
<span id="cb2-27"><a href="web-scraping-our-data.html#cb2-27"></a>  page &lt;-<span class="st"> </span><span class="kw">read_html</span>(url)</span>
<span id="cb2-28"><a href="web-scraping-our-data.html#cb2-28"></a>  </span>
<span id="cb2-29"><a href="web-scraping-our-data.html#cb2-29"></a>  <span class="co"># read the review page&#39;s html</span></span>
<span id="cb2-30"><a href="web-scraping-our-data.html#cb2-30"></a>  reviews_html &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb2-31"><a href="web-scraping-our-data.html#cb2-31"></a><span class="st">    </span><span class="kw">html_nodes</span>(<span class="st">&quot;.review&quot;</span>)</span>
<span id="cb2-32"><a href="web-scraping-our-data.html#cb2-32"></a>  </span>
<span id="cb2-33"><a href="web-scraping-our-data.html#cb2-33"></a>  <span class="co"># extract the informaiton we&#39;re interested in</span></span>
<span id="cb2-34"><a href="web-scraping-our-data.html#cb2-34"></a>  book_title &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb2-35"><a href="web-scraping-our-data.html#cb2-35"></a><span class="st">    </span><span class="kw">html_nodes</span>(<span class="st">&quot;#bookTitle&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-36"><a href="web-scraping-our-data.html#cb2-36"></a><span class="st">    </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></span>
<span id="cb2-37"><a href="web-scraping-our-data.html#cb2-37"></a><span class="st">    </span>stringr<span class="op">::</span><span class="kw">str_trim</span>()</span>
<span id="cb2-38"><a href="web-scraping-our-data.html#cb2-38"></a>  </span>
<span id="cb2-39"><a href="web-scraping-our-data.html#cb2-39"></a>  author_name &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb2-40"><a href="web-scraping-our-data.html#cb2-40"></a><span class="st">    </span><span class="kw">html_nodes</span>(<span class="st">&quot;.authorName span&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-41"><a href="web-scraping-our-data.html#cb2-41"></a><span class="st">    </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">1</span>)</span>
<span id="cb2-42"><a href="web-scraping-our-data.html#cb2-42"></a>  </span>
<span id="cb2-43"><a href="web-scraping-our-data.html#cb2-43"></a>  review_names &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_chr</span>(reviews_html, <span class="cf">function</span>(x) { <span class="kw">html_nodes</span>(x, <span class="st">&quot;.user&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">html_text</span>() })</span>
<span id="cb2-44"><a href="web-scraping-our-data.html#cb2-44"></a>  review_dates &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_chr</span>(reviews_html, <span class="cf">function</span>(x) {<span class="kw">html_nodes</span>(x, <span class="st">&quot;.reviewDate&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">html_text</span>()})</span>
<span id="cb2-45"><a href="web-scraping-our-data.html#cb2-45"></a>  review_text &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_chr</span>(reviews_html, <span class="cf">function</span>(x) {<span class="kw">html_nodes</span>(x, <span class="st">&quot;.readable span&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">paste0</span>(., <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">na_if</span>(<span class="dt">y=</span><span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_trim</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tail</span>(<span class="dv">1</span>)})</span>
<span id="cb2-46"><a href="web-scraping-our-data.html#cb2-46"></a>  review_rating &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map_chr</span>(reviews_html, <span class="cf">function</span>(x) {<span class="kw">html_nodes</span>(x, <span class="st">&quot;.staticStars&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">paste0</span>(., <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">na_if</span>(<span class="dt">y=</span><span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_trim</span>()}) </span>
<span id="cb2-47"><a href="web-scraping-our-data.html#cb2-47"></a>  </span>
<span id="cb2-48"><a href="web-scraping-our-data.html#cb2-48"></a>  <span class="co"># how many pages of reviews?</span></span>
<span id="cb2-49"><a href="web-scraping-our-data.html#cb2-49"></a>  <span class="co"># there may be an easier way but this should work</span></span>
<span id="cb2-50"><a href="web-scraping-our-data.html#cb2-50"></a>  num_pages &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb2-51"><a href="web-scraping-our-data.html#cb2-51"></a><span class="st">    </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></span>
<span id="cb2-52"><a href="web-scraping-our-data.html#cb2-52"></a><span class="st">    </span><span class="kw">str_extract_all</span>(<span class="st">&quot;(?&lt;=previous).*?(?=next)&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-53"><a href="web-scraping-our-data.html#cb2-53"></a><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tail</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-54"><a href="web-scraping-our-data.html#cb2-54"></a><span class="st">    </span>stringr<span class="op">::</span><span class="kw">str_trim</span>() <span class="op">%&gt;%</span></span>
<span id="cb2-55"><a href="web-scraping-our-data.html#cb2-55"></a><span class="st">    </span>stringr<span class="op">::</span><span class="kw">str_split</span>(<span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb2-56"><a href="web-scraping-our-data.html#cb2-56"></a><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span></span>
<span id="cb2-57"><a href="web-scraping-our-data.html#cb2-57"></a><span class="st">    </span><span class="kw">map_dbl</span>(as.double) <span class="op">%&gt;%</span></span>
<span id="cb2-58"><a href="web-scraping-our-data.html#cb2-58"></a><span class="st">    </span><span class="kw">max</span>()</span>
<span id="cb2-59"><a href="web-scraping-our-data.html#cb2-59"></a>  </span>
<span id="cb2-60"><a href="web-scraping-our-data.html#cb2-60"></a>  <span class="co"># put it all together</span></span>
<span id="cb2-61"><a href="web-scraping-our-data.html#cb2-61"></a>  page_reviews &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb2-62"><a href="web-scraping-our-data.html#cb2-62"></a>    <span class="dt">book_title =</span> book_title,</span>
<span id="cb2-63"><a href="web-scraping-our-data.html#cb2-63"></a>    <span class="dt">author_name =</span> author_name,</span>
<span id="cb2-64"><a href="web-scraping-our-data.html#cb2-64"></a>    <span class="dt">comment =</span> review_text,</span>
<span id="cb2-65"><a href="web-scraping-our-data.html#cb2-65"></a>    <span class="dt">names =</span> review_names,</span>
<span id="cb2-66"><a href="web-scraping-our-data.html#cb2-66"></a>    <span class="dt">rating =</span> review_rating,</span>
<span id="cb2-67"><a href="web-scraping-our-data.html#cb2-67"></a>    <span class="dt">dates =</span> lubridate<span class="op">::</span><span class="kw">mdy</span>(review_dates),</span>
<span id="cb2-68"><a href="web-scraping-our-data.html#cb2-68"></a>    <span class="dt">url =</span> url,</span>
<span id="cb2-69"><a href="web-scraping-our-data.html#cb2-69"></a>    <span class="dt">num_pages =</span> num_pages</span>
<span id="cb2-70"><a href="web-scraping-our-data.html#cb2-70"></a>  ) </span>
<span id="cb2-71"><a href="web-scraping-our-data.html#cb2-71"></a>  </span>
<span id="cb2-72"><a href="web-scraping-our-data.html#cb2-72"></a>  results &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(results, page_reviews)</span>
<span id="cb2-73"><a href="web-scraping-our-data.html#cb2-73"></a>}</span>
<span id="cb2-74"><a href="web-scraping-our-data.html#cb2-74"></a></span>
<span id="cb2-75"><a href="web-scraping-our-data.html#cb2-75"></a>filename &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;goodreads_&quot;</span>,genre,<span class="st">&quot;_reviews.csv&quot;</span>)</span>
<span id="cb2-76"><a href="web-scraping-our-data.html#cb2-76"></a>results <span class="op">%&gt;%</span></span>
<span id="cb2-77"><a href="web-scraping-our-data.html#cb2-77"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="dt">path =</span> filename)</span></code></pre></div>
</div>
</div>
<div id="yelp-embedded-json" class="section level2">
<h2><span class="header-section-number">3.4</span> Yelp: Embedded JSON</h2>
<p><a href="www.yelp.com">Yelp</a>, according to its website, “connects people with great local businesses” <span class="citation">(Yelp <a href="#ref-yelp_about_2020" role="doc-biblioref">2020</a>)</span>. Businesses can upload information like their location, hours, and services, and registered users can can leave reviews with text, star ratings, and pictures.</p>
<p>Yelp’s web design includes structured json data within its html. In other words, each Yelp review page has machine-readable data hidden inside it if you know where to look. We’ll exploit this by using a regular expression to extract the json from the html, then parse the json and work with it directly.</p>
<div id="scraping-the-index-1" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Scraping the Index</h3>
<p>First we’ll get the urls for each restaurant in Ottawa. We start at the base url for Ottawa restaurants and iterate through all of the pages: we could get the page numbers automatically, but here I just saw that there are 24 and hard-coded that number in. We extract the urls from the json in the page <em>without</em> parsing it using a regex. We could have parsed the json and done it using structured data, but since we’re only looking for one value type this was faster and worked fine.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="web-scraping-our-data.html#cb3-1"></a><span class="co"># the base url for restaurants in Ottawa</span></span>
<span id="cb3-2"><a href="web-scraping-our-data.html#cb3-2"></a>baseurl &lt;-<span class="st"> &quot;https://www.yelp.ca/search?cflt=restaurants&amp;find_loc=Ottawa%2C%20Ontario%2C%20CA&quot;</span></span>
<span id="cb3-3"><a href="web-scraping-our-data.html#cb3-3"></a></span>
<span id="cb3-4"><a href="web-scraping-our-data.html#cb3-4"></a><span class="co"># an empty tibble for our links</span></span>
<span id="cb3-5"><a href="web-scraping-our-data.html#cb3-5"></a>links &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb3-6"><a href="web-scraping-our-data.html#cb3-6"></a></span>
<span id="cb3-7"><a href="web-scraping-our-data.html#cb3-7"></a><span class="co"># loop through all 24 pages of Ottawa restaurants. (The number 24 was hard-coded to keep things moving.)</span></span>
<span id="cb3-8"><a href="web-scraping-our-data.html#cb3-8"></a><span class="cf">for</span> (pagenum <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">24</span>){</span>
<span id="cb3-9"><a href="web-scraping-our-data.html#cb3-9"></a>  <span class="kw">Sys.sleep</span>(<span class="dv">1</span>) </span>
<span id="cb3-10"><a href="web-scraping-our-data.html#cb3-10"></a>  </span>
<span id="cb3-11"><a href="web-scraping-our-data.html#cb3-11"></a>  <span class="co"># get the url for the page we&#39;re loading</span></span>
<span id="cb3-12"><a href="web-scraping-our-data.html#cb3-12"></a>  url &lt;-<span class="st"> </span><span class="kw">paste0</span>(baseurl, <span class="cf">if</span>(pagenum<span class="op">&gt;</span><span class="dv">1</span>){ <span class="kw">paste0</span>(<span class="st">&quot;&amp;start=&quot;</span>,(pagenum<span class="dv">-1</span>)<span class="op">*</span><span class="dv">10</span>) })</span>
<span id="cb3-13"><a href="web-scraping-our-data.html#cb3-13"></a>  </span>
<span id="cb3-14"><a href="web-scraping-our-data.html#cb3-14"></a>  <span class="co"># load the html for the page and print an update message</span></span>
<span id="cb3-15"><a href="web-scraping-our-data.html#cb3-15"></a>  text &lt;-<span class="st"> </span><span class="kw">read_html</span>(url) <span class="op">%&gt;%</span></span>
<span id="cb3-16"><a href="web-scraping-our-data.html#cb3-16"></a><span class="st">    </span><span class="kw">html_text</span>() </span>
<span id="cb3-17"><a href="web-scraping-our-data.html#cb3-17"></a>  <span class="kw">message</span>(<span class="st">&quot;**PAGE &quot;</span>,pagenum,<span class="st">&quot;: &quot;</span>, url)</span>
<span id="cb3-18"><a href="web-scraping-our-data.html#cb3-18"></a>  </span>
<span id="cb3-19"><a href="web-scraping-our-data.html#cb3-19"></a>  <span class="co"># extract the urls using a straight regex based on the json value key. we&#39;re not parsing any json here.</span></span>
<span id="cb3-20"><a href="web-scraping-our-data.html#cb3-20"></a>  urls &lt;-<span class="st"> </span>text <span class="op">%&gt;%</span></span>
<span id="cb3-21"><a href="web-scraping-our-data.html#cb3-21"></a><span class="st">    </span><span class="kw">str_extract_all</span>(<span class="st">&#39;(?&lt;=businessUrl&quot;:&quot;)(.*?)(?=&quot;)&#39;</span>) <span class="op">%&gt;%</span></span>
<span id="cb3-22"><a href="web-scraping-our-data.html#cb3-22"></a><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span></span>
<span id="cb3-23"><a href="web-scraping-our-data.html#cb3-23"></a><span class="st">    </span><span class="kw">enframe</span>() <span class="op">%&gt;%</span></span>
<span id="cb3-24"><a href="web-scraping-our-data.html#cb3-24"></a><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>name) <span class="op">%&gt;%</span></span>
<span id="cb3-25"><a href="web-scraping-our-data.html#cb3-25"></a><span class="st">    </span><span class="kw">filter</span> (<span class="op">!</span><span class="kw">str_detect</span>(value, <span class="st">&quot;ad_business_id&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb3-26"><a href="web-scraping-our-data.html#cb3-26"></a><span class="st">    </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></span>
<span id="cb3-27"><a href="web-scraping-our-data.html#cb3-27"></a><span class="st">    </span><span class="kw">transmute</span>(<span class="dt">url =</span> <span class="kw">paste0</span>(<span class="st">&quot;http://www.yelp.ca&quot;</span>, value))</span>
<span id="cb3-28"><a href="web-scraping-our-data.html#cb3-28"></a>  </span>
<span id="cb3-29"><a href="web-scraping-our-data.html#cb3-29"></a>  <span class="co"># add to our results</span></span>
<span id="cb3-30"><a href="web-scraping-our-data.html#cb3-30"></a>  links &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(links, urls)</span>
<span id="cb3-31"><a href="web-scraping-our-data.html#cb3-31"></a>}</span>
<span id="cb3-32"><a href="web-scraping-our-data.html#cb3-32"></a></span>
<span id="cb3-33"><a href="web-scraping-our-data.html#cb3-33"></a>links <span class="op">%&gt;%</span></span>
<span id="cb3-34"><a href="web-scraping-our-data.html#cb3-34"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="st">&quot;yelp_ottawa_links.csv&quot;</span>)</span></code></pre></div>
</div>
<div id="scraping-the-content-1" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Scraping the Content</h3>
<p>Scraping the content has two steps. First, now that we have a list of content urls, we can load each in turn and extract the reviews and the links for any additional review pages for this business. In the second step we’ll load these new links and get those reviews.</p>
<p>This function loads a single review page, extracts the machine-readable json using a regex, parses the json, and extracts the information we’re interested in. It then returns that information in a tibble.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="web-scraping-our-data.html#cb4-1"></a>get_review &lt;-<span class="st"> </span><span class="cf">function</span>(page, url) {</span>
<span id="cb4-2"><a href="web-scraping-our-data.html#cb4-2"></a>  </span>
<span id="cb4-3"><a href="web-scraping-our-data.html#cb4-3"></a>  <span class="co"># get the html</span></span>
<span id="cb4-4"><a href="web-scraping-our-data.html#cb4-4"></a>  text &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb4-5"><a href="web-scraping-our-data.html#cb4-5"></a><span class="st">    </span><span class="kw">html_text</span>()</span>
<span id="cb4-6"><a href="web-scraping-our-data.html#cb4-6"></a>  </span>
<span id="cb4-7"><a href="web-scraping-our-data.html#cb4-7"></a>  <span class="co"># extract the json with the review data</span></span>
<span id="cb4-8"><a href="web-scraping-our-data.html#cb4-8"></a>  json_text &lt;-<span class="st"> </span>text <span class="op">%&gt;%</span></span>
<span id="cb4-9"><a href="web-scraping-our-data.html#cb4-9"></a><span class="st">    </span><span class="kw">str_extract</span>(<span class="st">&#39;(?&lt;=&quot;reviewFeedQueryProps&quot;:)(.*)(&quot;query&quot;:&quot;&quot;</span><span class="ch">\\</span><span class="st">}</span><span class="ch">\\</span><span class="st">})&#39;</span>)</span>
<span id="cb4-10"><a href="web-scraping-our-data.html#cb4-10"></a>  </span>
<span id="cb4-11"><a href="web-scraping-our-data.html#cb4-11"></a>  <span class="co"># set our review_page results variable to NA, in case we don&#39;t get a results</span></span>
<span id="cb4-12"><a href="web-scraping-our-data.html#cb4-12"></a>  review_page &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb4-13"><a href="web-scraping-our-data.html#cb4-13"></a>  </span>
<span id="cb4-14"><a href="web-scraping-our-data.html#cb4-14"></a>  <span class="co"># make sure we have valid json text before we try to parse it</span></span>
<span id="cb4-15"><a href="web-scraping-our-data.html#cb4-15"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.na</span>(json_text)){</span>
<span id="cb4-16"><a href="web-scraping-our-data.html#cb4-16"></a>    <span class="co"># parse the json</span></span>
<span id="cb4-17"><a href="web-scraping-our-data.html#cb4-17"></a>    json_parse &lt;-<span class="st"> </span>json_text <span class="op">%&gt;%</span></span>
<span id="cb4-18"><a href="web-scraping-our-data.html#cb4-18"></a><span class="st">      </span>jsonlite<span class="op">::</span><span class="kw">fromJSON</span>()</span>
<span id="cb4-19"><a href="web-scraping-our-data.html#cb4-19"></a>    </span>
<span id="cb4-20"><a href="web-scraping-our-data.html#cb4-20"></a>    <span class="co"># pull out the variables we&#39;re interested in</span></span>
<span id="cb4-21"><a href="web-scraping-our-data.html#cb4-21"></a>    review_text &lt;-<span class="st"> </span>json_parse<span class="op">$</span>reviews<span class="op">$</span>comment<span class="op">$</span>text</span>
<span id="cb4-22"><a href="web-scraping-our-data.html#cb4-22"></a>    review_rating &lt;-<span class="st"> </span>json_parse<span class="op">$</span>reviews<span class="op">$</span>rating</span>
<span id="cb4-23"><a href="web-scraping-our-data.html#cb4-23"></a>    review_name &lt;-<span class="st"> </span>json_parse<span class="op">$</span>reviews<span class="op">$</span>user<span class="op">$</span>markupDisplayName</span>
<span id="cb4-24"><a href="web-scraping-our-data.html#cb4-24"></a>    review_date &lt;-<span class="st"> </span>json_parse<span class="op">$</span>reviews<span class="op">$</span>localizedDate</span>
<span id="cb4-25"><a href="web-scraping-our-data.html#cb4-25"></a>    review_business &lt;-<span class="st"> </span>json_parse<span class="op">$</span>reviews<span class="op">$</span>business<span class="op">$</span>name</span>
<span id="cb4-26"><a href="web-scraping-our-data.html#cb4-26"></a>    review_url &lt;-<span class="st"> </span><span class="kw">rep</span>(url, <span class="kw">length</span>(review_text))</span>
<span id="cb4-27"><a href="web-scraping-our-data.html#cb4-27"></a>    </span>
<span id="cb4-28"><a href="web-scraping-our-data.html#cb4-28"></a>    <span class="co"># put them all into a tibble</span></span>
<span id="cb4-29"><a href="web-scraping-our-data.html#cb4-29"></a>    review_page &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">business =</span> review_business,</span>
<span id="cb4-30"><a href="web-scraping-our-data.html#cb4-30"></a>                          <span class="dt">name =</span> review_name,</span>
<span id="cb4-31"><a href="web-scraping-our-data.html#cb4-31"></a>                          <span class="dt">date =</span> review_date,</span>
<span id="cb4-32"><a href="web-scraping-our-data.html#cb4-32"></a>                          <span class="dt">comment =</span> review_text,</span>
<span id="cb4-33"><a href="web-scraping-our-data.html#cb4-33"></a>                          <span class="dt">rating =</span> review_rating,</span>
<span id="cb4-34"><a href="web-scraping-our-data.html#cb4-34"></a>                          <span class="dt">url =</span> review_url)</span>
<span id="cb4-35"><a href="web-scraping-our-data.html#cb4-35"></a>  }</span>
<span id="cb4-36"><a href="web-scraping-our-data.html#cb4-36"></a>  </span>
<span id="cb4-37"><a href="web-scraping-our-data.html#cb4-37"></a>  <span class="co"># return either NA or a results tibble</span></span>
<span id="cb4-38"><a href="web-scraping-our-data.html#cb4-38"></a>  <span class="kw">return</span> (review_page)</span>
<span id="cb4-39"><a href="web-scraping-our-data.html#cb4-39"></a>}</span>
<span id="cb4-40"><a href="web-scraping-our-data.html#cb4-40"></a></span>
<span id="cb4-41"><a href="web-scraping-our-data.html#cb4-41"></a></span>
<span id="cb4-42"><a href="web-scraping-our-data.html#cb4-42"></a><span class="co"># simple function to pause for a random period of time</span></span>
<span id="cb4-43"><a href="web-scraping-our-data.html#cb4-43"></a>pause &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">min_wait =</span> <span class="dv">1</span>, <span class="dt">max_wait =</span> <span class="dv">3</span>){</span>
<span id="cb4-44"><a href="web-scraping-our-data.html#cb4-44"></a>  <span class="kw">runif</span>(<span class="dt">n=</span><span class="dv">1</span>, <span class="dt">min=</span>min_wait, <span class="dt">max =</span> max_wait) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">Sys.sleep</span>()</span>
<span id="cb4-45"><a href="web-scraping-our-data.html#cb4-45"></a>}</span></code></pre></div>
<p>We then proceed with step one, loading the initial list of links, extracting the reviews there, and collecting any more links to more reviews:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="web-scraping-our-data.html#cb5-1"></a><span class="co"># load our set of restaurant page links</span></span>
<span id="cb5-2"><a href="web-scraping-our-data.html#cb5-2"></a>base_links &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;yelp_ottawa_links.csv&quot;</span>)</span>
<span id="cb5-3"><a href="web-scraping-our-data.html#cb5-3"></a></span>
<span id="cb5-4"><a href="web-scraping-our-data.html#cb5-4"></a><span class="co"># set up an empty tibble for our reviews</span></span>
<span id="cb5-5"><a href="web-scraping-our-data.html#cb5-5"></a>reviews &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb5-6"><a href="web-scraping-our-data.html#cb5-6"></a></span>
<span id="cb5-7"><a href="web-scraping-our-data.html#cb5-7"></a><span class="co"># set up an empty tibble for the links we&#39;re going to visit later</span></span>
<span id="cb5-8"><a href="web-scraping-our-data.html#cb5-8"></a>more_links &lt;-<span class="st"> </span><span class="kw">tribble</span>(<span class="op">~</span>links)</span>
<span id="cb5-9"><a href="web-scraping-our-data.html#cb5-9"></a></span>
<span id="cb5-10"><a href="web-scraping-our-data.html#cb5-10"></a><span class="co"># now we&#39;re going to visit each page, extract the reviews from it, and find out how many *more* pages there are for this restaurant.</span></span>
<span id="cb5-11"><a href="web-scraping-our-data.html#cb5-11"></a><span class="co"># we&#39;ll keep track of those other pages and visit them later in a random order.</span></span>
<span id="cb5-12"><a href="web-scraping-our-data.html#cb5-12"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(base_links)) {</span>
<span id="cb5-13"><a href="web-scraping-our-data.html#cb5-13"></a>  <span class="co"># pause briefly</span></span>
<span id="cb5-14"><a href="web-scraping-our-data.html#cb5-14"></a>  <span class="kw">pause</span>()</span>
<span id="cb5-15"><a href="web-scraping-our-data.html#cb5-15"></a>  </span>
<span id="cb5-16"><a href="web-scraping-our-data.html#cb5-16"></a>  <span class="co"># get the url we&#39;re interested in</span></span>
<span id="cb5-17"><a href="web-scraping-our-data.html#cb5-17"></a>  url &lt;-<span class="st"> </span>links[[i]]</span>
<span id="cb5-18"><a href="web-scraping-our-data.html#cb5-18"></a>  </span>
<span id="cb5-19"><a href="web-scraping-our-data.html#cb5-19"></a>  <span class="co"># write an update, since I&#39;m impatient and want to know what&#39;s happening</span></span>
<span id="cb5-20"><a href="web-scraping-our-data.html#cb5-20"></a>  <span class="kw">message</span>(<span class="kw">paste0</span>(i,<span class="st">&quot;/&quot;</span>,<span class="kw">nrow</span>(base_links),<span class="st">&quot;: &quot;</span>, url))</span>
<span id="cb5-21"><a href="web-scraping-our-data.html#cb5-21"></a>  </span>
<span id="cb5-22"><a href="web-scraping-our-data.html#cb5-22"></a>  <span class="co"># read the url</span></span>
<span id="cb5-23"><a href="web-scraping-our-data.html#cb5-23"></a>  page &lt;-<span class="st"> </span><span class="kw">read_html</span>(url)</span>
<span id="cb5-24"><a href="web-scraping-our-data.html#cb5-24"></a>  </span>
<span id="cb5-25"><a href="web-scraping-our-data.html#cb5-25"></a>  <span class="co"># extract the reviews from the page</span></span>
<span id="cb5-26"><a href="web-scraping-our-data.html#cb5-26"></a>  review_page &lt;-<span class="st"> </span><span class="kw">get_review</span>(page, url)</span>
<span id="cb5-27"><a href="web-scraping-our-data.html#cb5-27"></a>  </span>
<span id="cb5-28"><a href="web-scraping-our-data.html#cb5-28"></a>  <span class="co"># add these reviews to our list of reviews</span></span>
<span id="cb5-29"><a href="web-scraping-our-data.html#cb5-29"></a>  reviews &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(reviews, review_page)</span>
<span id="cb5-30"><a href="web-scraping-our-data.html#cb5-30"></a>  </span>
<span id="cb5-31"><a href="web-scraping-our-data.html#cb5-31"></a>  <span class="co"># now find out how many other pages there are for this restaurant</span></span>
<span id="cb5-32"><a href="web-scraping-our-data.html#cb5-32"></a>  <span class="co"># we&#39;ll regex to find the second half of &quot;dd of dd&quot;, where d is a digit (and it could be either one or two digits--see the regex below)</span></span>
<span id="cb5-33"><a href="web-scraping-our-data.html#cb5-33"></a>  num_pages &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb5-34"><a href="web-scraping-our-data.html#cb5-34"></a><span class="st">    </span><span class="kw">html_node</span>((<span class="st">&quot;.text-align--center__373c0__2n2yQ .text-align--left__373c0__2XGa-&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb5-35"><a href="web-scraping-our-data.html#cb5-35"></a><span class="st">    </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></span>
<span id="cb5-36"><a href="web-scraping-our-data.html#cb5-36"></a><span class="st">    </span><span class="kw">str_extract</span>(<span class="st">&quot;(?&lt;=of )(</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d?)&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb5-37"><a href="web-scraping-our-data.html#cb5-37"></a><span class="st">    </span><span class="kw">as.integer</span>()</span>
<span id="cb5-38"><a href="web-scraping-our-data.html#cb5-38"></a>  </span>
<span id="cb5-39"><a href="web-scraping-our-data.html#cb5-39"></a>  <span class="co"># make sure we don&#39;t get an NA</span></span>
<span id="cb5-40"><a href="web-scraping-our-data.html#cb5-40"></a>  <span class="cf">if</span> (<span class="kw">is.na</span>(num_pages)) num_pages &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb5-41"><a href="web-scraping-our-data.html#cb5-41"></a>  </span>
<span id="cb5-42"><a href="web-scraping-our-data.html#cb5-42"></a>  <span class="co"># if there&#39;s more than one page, construct the links and add them to our list of links to read next</span></span>
<span id="cb5-43"><a href="web-scraping-our-data.html#cb5-43"></a>  <span class="cf">if</span> (num_pages <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb5-44"><a href="web-scraping-our-data.html#cb5-44"></a>    more_links &lt;-<span class="st"> </span>more_links <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-45"><a href="web-scraping-our-data.html#cb5-45"></a><span class="st">      </span><span class="kw">add_row</span>(<span class="dt">links =</span> <span class="kw">paste0</span>(url, <span class="st">&quot;?start=&quot;</span>,(<span class="dv">1</span><span class="op">:</span>(num_pages<span class="dv">-1</span>))<span class="op">*</span><span class="dv">20</span>) )</span>
<span id="cb5-46"><a href="web-scraping-our-data.html#cb5-46"></a>  }</span>
<span id="cb5-47"><a href="web-scraping-our-data.html#cb5-47"></a>  </span>
<span id="cb5-48"><a href="web-scraping-our-data.html#cb5-48"></a>} <span class="co"># end for i in 1:nrow(base_links)</span></span>
<span id="cb5-49"><a href="web-scraping-our-data.html#cb5-49"></a></span>
<span id="cb5-50"><a href="web-scraping-our-data.html#cb5-50"></a><span class="co"># save our results</span></span>
<span id="cb5-51"><a href="web-scraping-our-data.html#cb5-51"></a>reviews <span class="op">%&gt;%</span></span>
<span id="cb5-52"><a href="web-scraping-our-data.html#cb5-52"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="st">&quot;data/ottawa-reviews-1.csv&quot;</span>)</span>
<span id="cb5-53"><a href="web-scraping-our-data.html#cb5-53"></a></span>
<span id="cb5-54"><a href="web-scraping-our-data.html#cb5-54"></a>more_links <span class="op">%&gt;%</span></span>
<span id="cb5-55"><a href="web-scraping-our-data.html#cb5-55"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="st">&quot;data/ottawa_more_links.csv&quot;</span>)</span></code></pre></div>
<p>In step two, we’ll repeat the process for the new links we collected:</p>
<p>Now let’s do the same thing for the extra links we got:
note it’s stopping me every 136 or so and giving a 503 error, so i’m either rebooting my modem to get a new ip address or tethering to my phone for a bit</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="web-scraping-our-data.html#cb6-1"></a>links &lt;-<span class="st"> </span>more_links</span>
<span id="cb6-2"><a href="web-scraping-our-data.html#cb6-2"></a></span>
<span id="cb6-3"><a href="web-scraping-our-data.html#cb6-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(links)) {</span>
<span id="cb6-4"><a href="web-scraping-our-data.html#cb6-4"></a>  <span class="co"># pause briefly for random interval</span></span>
<span id="cb6-5"><a href="web-scraping-our-data.html#cb6-5"></a>  <span class="kw">pause</span>()</span>
<span id="cb6-6"><a href="web-scraping-our-data.html#cb6-6"></a>  </span>
<span id="cb6-7"><a href="web-scraping-our-data.html#cb6-7"></a>  <span class="co"># get the url we&#39;re interested in</span></span>
<span id="cb6-8"><a href="web-scraping-our-data.html#cb6-8"></a>  url &lt;-<span class="st"> </span>links[[i]]</span>
<span id="cb6-9"><a href="web-scraping-our-data.html#cb6-9"></a>  </span>
<span id="cb6-10"><a href="web-scraping-our-data.html#cb6-10"></a>  <span class="co"># write an update, since I&#39;m impatient and want to know what&#39;s happening</span></span>
<span id="cb6-11"><a href="web-scraping-our-data.html#cb6-11"></a>  <span class="kw">message</span>(<span class="kw">paste0</span>(i,<span class="st">&quot;/&quot;</span>,<span class="kw">length</span>(links),<span class="st">&quot;: &quot;</span>, url))</span>
<span id="cb6-12"><a href="web-scraping-our-data.html#cb6-12"></a></span>
<span id="cb6-13"><a href="web-scraping-our-data.html#cb6-13"></a>  <span class="kw">message</span>(<span class="st">&quot;  Loading page.&quot;</span>)</span>
<span id="cb6-14"><a href="web-scraping-our-data.html#cb6-14"></a>  <span class="co"># read the url</span></span>
<span id="cb6-15"><a href="web-scraping-our-data.html#cb6-15"></a>  page &lt;-<span class="st"> </span><span class="kw">read_html</span>(url)</span>
<span id="cb6-16"><a href="web-scraping-our-data.html#cb6-16"></a>  </span>
<span id="cb6-17"><a href="web-scraping-our-data.html#cb6-17"></a>  <span class="kw">message</span>(<span class="st">&quot;  Parsing review.&quot;</span>)</span>
<span id="cb6-18"><a href="web-scraping-our-data.html#cb6-18"></a>  <span class="co"># extract the reviews from the page</span></span>
<span id="cb6-19"><a href="web-scraping-our-data.html#cb6-19"></a>  review_page &lt;-<span class="st"> </span><span class="kw">get_review</span>(page, url)</span>
<span id="cb6-20"><a href="web-scraping-our-data.html#cb6-20"></a>  </span>
<span id="cb6-21"><a href="web-scraping-our-data.html#cb6-21"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.na</span>(review_page)){</span>
<span id="cb6-22"><a href="web-scraping-our-data.html#cb6-22"></a>    <span class="kw">message</span> (<span class="st">&quot;  Adding to inventory.&quot;</span>)</span>
<span id="cb6-23"><a href="web-scraping-our-data.html#cb6-23"></a>    <span class="co"># add these reviews to our list of reviews</span></span>
<span id="cb6-24"><a href="web-scraping-our-data.html#cb6-24"></a>    reviews &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(reviews, review_page)</span>
<span id="cb6-25"><a href="web-scraping-our-data.html#cb6-25"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-26"><a href="web-scraping-our-data.html#cb6-26"></a>    <span class="kw">message</span> (<span class="st">&quot;  No valid json found.&quot;</span>)</span>
<span id="cb6-27"><a href="web-scraping-our-data.html#cb6-27"></a>  }</span>
<span id="cb6-28"><a href="web-scraping-our-data.html#cb6-28"></a>} <span class="co"># end for i in 1:nrow(base_links)</span></span>
<span id="cb6-29"><a href="web-scraping-our-data.html#cb6-29"></a></span>
<span id="cb6-30"><a href="web-scraping-our-data.html#cb6-30"></a></span>
<span id="cb6-31"><a href="web-scraping-our-data.html#cb6-31"></a>reviews <span class="op">%&gt;%</span></span>
<span id="cb6-32"><a href="web-scraping-our-data.html#cb6-32"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="st">&quot;ottawa-reviews-2.csv&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="mec-reverse-engineering-client-side-api-calls" class="section level2">
<h2><span class="header-section-number">3.5</span> MEC: Reverse-Engineering Client-Side API Calls</h2>
<p>MEC’s website uses a completely different design principle that makes it seem more difficult to extract information. If you inspect the html for one of MEC’s product pages, you’ll find that the review information simply isn’t there! It’s quite mysterious.</p>
<p>The secret is that MEC’s site uses client-side API calls to download the data which is then displayed locally. To solve this puzzle, I needed to use Chrome’s developer console (opened with <em>Control-Shift-J</em>) to see the network activity (under the <em>Network</em> tab) happening each time I loaded a new product page. I discovered that my browser was making API calls to a specific server, and by comparing the calls for a few products I found that the main difference was the product ID. This let me reverse-engineer the syntax just enough to be able to call it myself and get reviews for any product based on its ID. I also found that there was one API call for the first page of reviews and a different one for loading more reviews, so I built functions for both of them.</p>
<p>As a result, the index in this case is a list of product IDs rather than urls, and the content is the result of API calls rather than web pages. However, the principles remain the same.</p>
<div id="scraping-the-index-2" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Scraping the Index</h3>
<p>This code block collects product IDs for <a href="https://www.mec.ca/en/products/clothing/clothing-accessories/gloves-and-mittens/c/987">mittens and gloves</a>. Each product category has a different catalogue page, so I modified the code to load a few different kinds of products. We load the first page, use a regex to figure out how many pages there are, then use css selectors to extract the IDs for products with reviews.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="web-scraping-our-data.html#cb7-1"></a><span class="co"># enter the base url by hand</span></span>
<span id="cb7-2"><a href="web-scraping-our-data.html#cb7-2"></a>base_url &lt;-<span class="st"> &quot;https://www.mec.ca/en/products/clothing/clothing-accessories/gloves-and-mittens/c/987&quot;</span></span>
<span id="cb7-3"><a href="web-scraping-our-data.html#cb7-3"></a></span>
<span id="cb7-4"><a href="web-scraping-our-data.html#cb7-4"></a><span class="co"># enter the product type by hand</span></span>
<span id="cb7-5"><a href="web-scraping-our-data.html#cb7-5"></a>product_type &lt;-<span class="st"> &quot;gloves-and-mittens&quot;</span></span>
<span id="cb7-6"><a href="web-scraping-our-data.html#cb7-6"></a></span>
<span id="cb7-7"><a href="web-scraping-our-data.html#cb7-7"></a><span class="co"># read the page</span></span>
<span id="cb7-8"><a href="web-scraping-our-data.html#cb7-8"></a>page &lt;-<span class="st"> </span><span class="kw">read_html</span>(base_url)</span>
<span id="cb7-9"><a href="web-scraping-our-data.html#cb7-9"></a></span>
<span id="cb7-10"><a href="web-scraping-our-data.html#cb7-10"></a><span class="co"># get the number of items using a CSS selector and a regex</span></span>
<span id="cb7-11"><a href="web-scraping-our-data.html#cb7-11"></a><span class="co"># we expect to find between one and three digits</span></span>
<span id="cb7-12"><a href="web-scraping-our-data.html#cb7-12"></a>num_items &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb7-13"><a href="web-scraping-our-data.html#cb7-13"></a><span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&quot;.qa-filter-group__count&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-14"><a href="web-scraping-our-data.html#cb7-14"></a><span class="st">  </span><span class="kw">html_text</span>() <span class="op">%&gt;%</span></span>
<span id="cb7-15"><a href="web-scraping-our-data.html#cb7-15"></a><span class="st">  </span><span class="kw">str_extract</span>(<span class="st">&quot;(</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d?</span><span class="ch">\\</span><span class="st">d?)&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-16"><a href="web-scraping-our-data.html#cb7-16"></a><span class="st">  </span><span class="kw">as.integer</span>()</span>
<span id="cb7-17"><a href="web-scraping-our-data.html#cb7-17"></a></span>
<span id="cb7-18"><a href="web-scraping-our-data.html#cb7-18"></a><span class="co"># there are at most 36 items per page</span></span>
<span id="cb7-19"><a href="web-scraping-our-data.html#cb7-19"></a>num_pages &lt;-<span class="st"> </span>(num_items <span class="op">/</span><span class="st"> </span><span class="dv">36</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ceiling</span>()</span>
<span id="cb7-20"><a href="web-scraping-our-data.html#cb7-20"></a></span>
<span id="cb7-21"><a href="web-scraping-our-data.html#cb7-21"></a><span class="co"># first let&#39;s do the items on this page</span></span>
<span id="cb7-22"><a href="web-scraping-our-data.html#cb7-22"></a><span class="co"># find each link to a product, filter out any that don&#39;t have reviews yet, extract the product ids</span></span>
<span id="cb7-23"><a href="web-scraping-our-data.html#cb7-23"></a>product_ids &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb7-24"><a href="web-scraping-our-data.html#cb7-24"></a><span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&quot;.rating__count__link&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-25"><a href="web-scraping-our-data.html#cb7-25"></a><span class="st">  </span><span class="kw">html_attrs</span>() <span class="op">%&gt;%</span></span>
<span id="cb7-26"><a href="web-scraping-our-data.html#cb7-26"></a><span class="st">  </span><span class="kw">enframe</span>() <span class="op">%&gt;%</span></span>
<span id="cb7-27"><a href="web-scraping-our-data.html#cb7-27"></a><span class="st">  </span><span class="kw">unnest_wider</span>(value) <span class="op">%&gt;%</span></span>
<span id="cb7-28"><a href="web-scraping-our-data.html#cb7-28"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(title, <span class="st">&quot;No reviews yet&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb7-29"><a href="web-scraping-our-data.html#cb7-29"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">product_id =</span> <span class="kw">str_extract</span>(href, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d-</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb7-30"><a href="web-scraping-our-data.html#cb7-30"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>name, <span class="op">-</span>class)</span>
<span id="cb7-31"><a href="web-scraping-our-data.html#cb7-31"></a></span>
<span id="cb7-32"><a href="web-scraping-our-data.html#cb7-32"></a><span class="co"># now we load the extra pages, if there are any</span></span>
<span id="cb7-33"><a href="web-scraping-our-data.html#cb7-33"></a><span class="cf">if</span> (num_pages <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) {</span>
<span id="cb7-34"><a href="web-scraping-our-data.html#cb7-34"></a>  <span class="co"># we iterate from 1 to num_pages-1, because MEC calls the first extra page page 1</span></span>
<span id="cb7-35"><a href="web-scraping-our-data.html#cb7-35"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(num_pages<span class="dv">-1</span>)){</span>
<span id="cb7-36"><a href="web-scraping-our-data.html#cb7-36"></a>    <span class="co"># send an update to the console</span></span>
<span id="cb7-37"><a href="web-scraping-our-data.html#cb7-37"></a>    <span class="kw">message</span>(<span class="kw">paste0</span>(i,<span class="st">&quot;/&quot;</span>,(num_pages<span class="dv">-1</span>)))</span>
<span id="cb7-38"><a href="web-scraping-our-data.html#cb7-38"></a>    </span>
<span id="cb7-39"><a href="web-scraping-our-data.html#cb7-39"></a>    <span class="co"># wait a little bit</span></span>
<span id="cb7-40"><a href="web-scraping-our-data.html#cb7-40"></a>    <span class="kw">patience</span>(<span class="dt">min_wait =</span> <span class="dv">3</span>, <span class="dt">max_wait =</span> <span class="dv">10</span>)</span>
<span id="cb7-41"><a href="web-scraping-our-data.html#cb7-41"></a>    </span>
<span id="cb7-42"><a href="web-scraping-our-data.html#cb7-42"></a>    <span class="co"># get the new url for the next page</span></span>
<span id="cb7-43"><a href="web-scraping-our-data.html#cb7-43"></a>    url &lt;-<span class="st"> </span><span class="kw">paste0</span>(base_url,<span class="st">&quot;?page=&quot;</span>,i)</span>
<span id="cb7-44"><a href="web-scraping-our-data.html#cb7-44"></a>    </span>
<span id="cb7-45"><a href="web-scraping-our-data.html#cb7-45"></a>    <span class="co"># load the next page</span></span>
<span id="cb7-46"><a href="web-scraping-our-data.html#cb7-46"></a>    page &lt;-<span class="st"> </span><span class="kw">read_html</span>(base_url)</span>
<span id="cb7-47"><a href="web-scraping-our-data.html#cb7-47"></a>    </span>
<span id="cb7-48"><a href="web-scraping-our-data.html#cb7-48"></a>    <span class="co"># find each link to a product, filter out any that don&#39;t have reviews yet, extract the product ids</span></span>
<span id="cb7-49"><a href="web-scraping-our-data.html#cb7-49"></a>    new_product_ids &lt;-<span class="st"> </span>page <span class="op">%&gt;%</span></span>
<span id="cb7-50"><a href="web-scraping-our-data.html#cb7-50"></a><span class="st">      </span><span class="kw">html_nodes</span>(<span class="st">&quot;.rating__count__link&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-51"><a href="web-scraping-our-data.html#cb7-51"></a><span class="st">      </span><span class="kw">html_attrs</span>() <span class="op">%&gt;%</span></span>
<span id="cb7-52"><a href="web-scraping-our-data.html#cb7-52"></a><span class="st">      </span><span class="kw">enframe</span>() <span class="op">%&gt;%</span></span>
<span id="cb7-53"><a href="web-scraping-our-data.html#cb7-53"></a><span class="st">      </span><span class="kw">unnest_wider</span>(value) <span class="op">%&gt;%</span></span>
<span id="cb7-54"><a href="web-scraping-our-data.html#cb7-54"></a><span class="st">      </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(title, <span class="st">&quot;No reviews yet&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb7-55"><a href="web-scraping-our-data.html#cb7-55"></a><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">product_id =</span> <span class="kw">str_extract</span>(href, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d-</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d</span><span class="ch">\\</span><span class="st">d&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb7-56"><a href="web-scraping-our-data.html#cb7-56"></a><span class="st">      </span><span class="kw">select</span>(<span class="op">-</span>name, <span class="op">-</span>class)</span>
<span id="cb7-57"><a href="web-scraping-our-data.html#cb7-57"></a>    </span>
<span id="cb7-58"><a href="web-scraping-our-data.html#cb7-58"></a>    <span class="co"># add it to our list</span></span>
<span id="cb7-59"><a href="web-scraping-our-data.html#cb7-59"></a>    product_ids &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(product_ids, new_product_ids)</span>
<span id="cb7-60"><a href="web-scraping-our-data.html#cb7-60"></a>    </span>
<span id="cb7-61"><a href="web-scraping-our-data.html#cb7-61"></a>  } <span class="co"># end for (i in 1:(num_pages-1))</span></span>
<span id="cb7-62"><a href="web-scraping-our-data.html#cb7-62"></a>} <span class="co"># end if (num_pages &gt;1)</span></span>
<span id="cb7-63"><a href="web-scraping-our-data.html#cb7-63"></a></span>
<span id="cb7-64"><a href="web-scraping-our-data.html#cb7-64"></a></span>
<span id="cb7-65"><a href="web-scraping-our-data.html#cb7-65"></a>product_ids <span class="op">%&gt;%</span></span>
<span id="cb7-66"><a href="web-scraping-our-data.html#cb7-66"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="kw">paste0</span>(<span class="st">&quot;data/product_ids_&quot;</span>,product_type,<span class="st">&quot;.csv&quot;</span>))</span></code></pre></div>
</div>
<div id="functions-for-api-calls" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Functions for API Calls</h3>
<p>Next, I defined functions to make the API calls and to process their results. The API calls are quite ugly–I could have spent more time figuring out exactly how they worked and slimmed them down, but this worked.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="web-scraping-our-data.html#cb8-1"></a>get_first_api_url &lt;-<span class="st"> </span><span class="cf">function</span>(product_code){</span>
<span id="cb8-2"><a href="web-scraping-our-data.html#cb8-2"></a>  api_url &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;https://api.bazaarvoice.com/data/batch.json?passkey=dm7fc6czngulvbz4o3ju0ld9f&amp;apiversion=5.5&amp;displaycode=9421-en_ca&amp;resource.q0=products&amp;filter.q0=id%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;stats.q0=questions%2Creviews&amp;filteredstats.q0=questions%2Creviews&amp;filter_questions.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_answers.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_reviews.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_reviewcomments.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;resource.q1=questions&amp;filter.q1=productid%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;filter.q1=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;sort.q1=totalanswercount%3Adesc&amp;stats.q1=questions&amp;filteredstats.q1=questions&amp;include.q1=authors%2Cproducts%2Canswers&amp;filter_questions.q1=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_answers.q1=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q1=10&amp;offset.q1=0&amp;limit_answers.q1=10&amp;resource.q2=reviews&amp;filter.q2=isratingsonly%3Aeq%3Afalse&amp;filter.q2=productid%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;filter.q2=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;sort.q2=helpfulness%3Adesc%2Ctotalpositivefeedbackcount%3Adesc&amp;stats.q2=reviews&amp;filteredstats.q2=reviews&amp;include.q2=authors%2Cproducts%2Ccomments&amp;filter_reviews.q2=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_reviewcomments.q2=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_comments.q2=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q2=8&amp;offset.q2=0&amp;limit_comments.q2=3&amp;resource.q3=reviews&amp;filter.q3=productid%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;filter.q3=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q3=1&amp;resource.q4=reviews&amp;filter.q4=productid%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;filter.q4=isratingsonly%3Aeq%3Afalse&amp;filter.q4=issyndicated%3Aeq%3Afalse&amp;filter.q4=rating%3Agt%3A3&amp;filter.q4=totalpositivefeedbackcount%3Agte%3A3&amp;filter.q4=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;sort.q4=totalpositivefeedbackcount%3Adesc&amp;include.q4=authors%2Creviews%2Cproducts&amp;filter_reviews.q4=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q4=1&amp;resource.q5=reviews&amp;filter.q5=productid%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;filter.q5=isratingsonly%3Aeq%3Afalse&amp;filter.q5=issyndicated%3Aeq%3Afalse&amp;filter.q5=rating%3Alte%3A3&amp;filter.q5=totalpositivefeedbackcount%3Agte%3A3&amp;filter.q5=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;sort.q5=totalpositivefeedbackcount%3Adesc&amp;include.q5=authors%2Creviews%2Cproducts&amp;filter_reviews.q5=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q5=1&amp;callback=BV._internal.dataHandler0&quot;</span>)</span>
<span id="cb8-3"><a href="web-scraping-our-data.html#cb8-3"></a></span>
<span id="cb8-4"><a href="web-scraping-our-data.html#cb8-4"></a>    <span class="kw">return</span>(api_url)</span>
<span id="cb8-5"><a href="web-scraping-our-data.html#cb8-5"></a>}</span>
<span id="cb8-6"><a href="web-scraping-our-data.html#cb8-6"></a></span>
<span id="cb8-7"><a href="web-scraping-our-data.html#cb8-7"></a>get_second_api_url &lt;-<span class="st"> </span><span class="cf">function</span>(product_code){</span>
<span id="cb8-8"><a href="web-scraping-our-data.html#cb8-8"></a>  api_url &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;https://api.bazaarvoice.com/data/batch.json?passkey=dm7fc6czngulvbz4o3ju0ld9f&amp;apiversion=5.5&amp;displaycode=9421-en_ca&amp;resource.q0=reviews&amp;filter.q0=isratingsonly%3Aeq%3Afalse&amp;filter.q0=productid%3Aeq%3A&quot;</span>,product_code,<span class="st">&quot;&amp;filter.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;sort.q0=helpfulness%3Adesc%2Ctotalpositivefeedbackcount%3Adesc&amp;stats.q0=reviews&amp;filteredstats.q0=reviews&amp;include.q0=authors%2Cproducts%2Ccomments&amp;filter_reviews.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_reviewcomments.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_comments.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q0=30&amp;offset.q0=8&amp;limit_comments.q0=3&amp;callback=bv_351_44883&quot;</span>)</span>
<span id="cb8-9"><a href="web-scraping-our-data.html#cb8-9"></a>  </span>
<span id="cb8-10"><a href="web-scraping-our-data.html#cb8-10"></a>  <span class="co">#api_url &lt;- paste0(&quot;https://api.bazaarvoice.com/data/batch.json?passkey=dm7fc6czngulvbz4o3ju0ld9f&amp;apiversion=5.5&amp;displaycode=9421-en_ca&amp;resource.q0=reviews&amp;filter.q0=isratingsonly%3Aeq%3Afalse&amp;filter.q0=productid%3Aeq%3A&quot;,product_code,&quot;&amp;filter.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;sort.q0=helpfulness%3Adesc%2Ctotalpositivefeedbackcount%3Adesc&amp;stats.q0=reviews&amp;filteredstats.q0=reviews&amp;include.q0=authors%2Cproducts%2Ccomments&amp;filter_reviews.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_reviewcomments.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;filter_comments.q0=contentlocale%3Aeq%3Aen*%2Cfr_CA%2Cen_CA&amp;limit.q0=500&amp;offset.q0=0&amp;limit_comments.q0=3&amp;callback=bv_351_44883&quot;)</span></span>
<span id="cb8-11"><a href="web-scraping-our-data.html#cb8-11"></a>  </span>
<span id="cb8-12"><a href="web-scraping-our-data.html#cb8-12"></a>  <span class="kw">return</span>(api_url)</span>
<span id="cb8-13"><a href="web-scraping-our-data.html#cb8-13"></a>}</span>
<span id="cb8-14"><a href="web-scraping-our-data.html#cb8-14"></a></span>
<span id="cb8-15"><a href="web-scraping-our-data.html#cb8-15"></a><span class="co"># function to go through the list and extract meaningful results</span></span>
<span id="cb8-16"><a href="web-scraping-our-data.html#cb8-16"></a>get_review &lt;-<span class="st"> </span><span class="cf">function</span>(x){</span>
<span id="cb8-17"><a href="web-scraping-our-data.html#cb8-17"></a>  product_id &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.null</span>(x<span class="op">$</span>ProductId), x<span class="op">$</span>ProductId, <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-18"><a href="web-scraping-our-data.html#cb8-18"></a>  user_name &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.null</span>(x<span class="op">$</span>UserNickname), x<span class="op">$</span>UserNickname, <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-19"><a href="web-scraping-our-data.html#cb8-19"></a>  rating &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.null</span>(x<span class="op">$</span>Rating), x<span class="op">$</span>Rating, <span class="dv">0</span>)</span>
<span id="cb8-20"><a href="web-scraping-our-data.html#cb8-20"></a>  </span>
<span id="cb8-21"><a href="web-scraping-our-data.html#cb8-21"></a>  review_date &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.null</span>(x<span class="op">$</span>SubmissionTime), x<span class="op">$</span>SubmissionTime, <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-22"><a href="web-scraping-our-data.html#cb8-22"></a>  review_text &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.null</span>(x<span class="op">$</span>ReviewText), x<span class="op">$</span>ReviewText, <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-23"><a href="web-scraping-our-data.html#cb8-23"></a>  review_title &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.null</span>(x<span class="op">$</span>Title), x<span class="op">$</span>Title, <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-24"><a href="web-scraping-our-data.html#cb8-24"></a>  </span>
<span id="cb8-25"><a href="web-scraping-our-data.html#cb8-25"></a><span class="co">#  message (&quot;sofa sogood&quot;)</span></span>
<span id="cb8-26"><a href="web-scraping-our-data.html#cb8-26"></a>  </span>
<span id="cb8-27"><a href="web-scraping-our-data.html#cb8-27"></a>  results &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb8-28"><a href="web-scraping-our-data.html#cb8-28"></a>    <span class="dt">product_id =</span> product_id,</span>
<span id="cb8-29"><a href="web-scraping-our-data.html#cb8-29"></a>    <span class="dt">user_name=</span> user_name,</span>
<span id="cb8-30"><a href="web-scraping-our-data.html#cb8-30"></a>    <span class="dt">rating_num =</span> rating,</span>
<span id="cb8-31"><a href="web-scraping-our-data.html#cb8-31"></a>    <span class="dt">review_date =</span>review_date,</span>
<span id="cb8-32"><a href="web-scraping-our-data.html#cb8-32"></a>    <span class="dt">review_text =</span>review_text ,</span>
<span id="cb8-33"><a href="web-scraping-our-data.html#cb8-33"></a>    <span class="dt">review_title =</span> review_title</span>
<span id="cb8-34"><a href="web-scraping-our-data.html#cb8-34"></a>  )</span>
<span id="cb8-35"><a href="web-scraping-our-data.html#cb8-35"></a>  <span class="kw">return</span>(results)</span>
<span id="cb8-36"><a href="web-scraping-our-data.html#cb8-36"></a>}</span></code></pre></div>
</div>
<div id="scraping-the-content-2" class="section level3">
<h3><span class="header-section-number">3.5.3</span> Scraping the Content</h3>
<p>Now that we have the product ids, we can loop through them and call the API to get the reviews.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="web-scraping-our-data.html#cb9-1"></a><span class="co"># set up our results tibble</span></span>
<span id="cb9-2"><a href="web-scraping-our-data.html#cb9-2"></a>all_reviews &lt;-<span class="st"> </span><span class="kw">tibble</span>()</span>
<span id="cb9-3"><a href="web-scraping-our-data.html#cb9-3"></a></span>
<span id="cb9-4"><a href="web-scraping-our-data.html#cb9-4"></a><span class="co"># #20 seems to have no reviews, json_results didn&#39;t have SubmissionTime, so added that to conditions</span></span>
<span id="cb9-5"><a href="web-scraping-our-data.html#cb9-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(product_ids)){</span>
<span id="cb9-6"><a href="web-scraping-our-data.html#cb9-6"></a>  <span class="co"># print an update message and wait nicely</span></span>
<span id="cb9-7"><a href="web-scraping-our-data.html#cb9-7"></a>  product_id &lt;-<span class="st"> </span>product_ids<span class="op">$</span>product_id[[i]]</span>
<span id="cb9-8"><a href="web-scraping-our-data.html#cb9-8"></a>  <span class="kw">message</span>(<span class="kw">paste0</span>(<span class="st">&quot;Product #&quot;</span>,i,<span class="st">&quot;/&quot;</span>,<span class="kw">nrow</span>(product_ids),<span class="st">&quot;: &quot;</span>,product_id))</span>
<span id="cb9-9"><a href="web-scraping-our-data.html#cb9-9"></a>  <span class="kw">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb9-10"><a href="web-scraping-our-data.html#cb9-10"></a>  </span>
<span id="cb9-11"><a href="web-scraping-our-data.html#cb9-11"></a>  api_url &lt;-<span class="st">  </span><span class="kw">get_first_api_url</span>(product_id)</span>
<span id="cb9-12"><a href="web-scraping-our-data.html#cb9-12"></a>  </span>
<span id="cb9-13"><a href="web-scraping-our-data.html#cb9-13"></a>  <span class="co"># call the API</span></span>
<span id="cb9-14"><a href="web-scraping-our-data.html#cb9-14"></a>  text &lt;-<span class="st"> </span><span class="kw">GET</span>(api_url) <span class="op">%&gt;%</span></span>
<span id="cb9-15"><a href="web-scraping-our-data.html#cb9-15"></a><span class="st">    </span><span class="kw">content</span>(<span class="st">&quot;text&quot;</span>)</span>
<span id="cb9-16"><a href="web-scraping-our-data.html#cb9-16"></a>  </span>
<span id="cb9-17"><a href="web-scraping-our-data.html#cb9-17"></a>  <span class="co"># parse the returned text into json</span></span>
<span id="cb9-18"><a href="web-scraping-our-data.html#cb9-18"></a>  json_parsed &lt;-<span class="st"> </span>text <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb9-19"><a href="web-scraping-our-data.html#cb9-19"></a><span class="st">    </span><span class="kw">str_extract</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">{(.*)</span><span class="ch">\\</span><span class="st">}&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb9-20"><a href="web-scraping-our-data.html#cb9-20"></a><span class="st">    </span><span class="co">#str_extract(&quot;(?&lt;=BV._internal.dataHandler0\\()(.*)&quot;)#(?=\\))&quot;) %&gt;%</span></span>
<span id="cb9-21"><a href="web-scraping-our-data.html#cb9-21"></a><span class="st">    </span>jsonlite<span class="op">::</span><span class="kw">parse_json</span>()</span>
<span id="cb9-22"><a href="web-scraping-our-data.html#cb9-22"></a>  </span>
<span id="cb9-23"><a href="web-scraping-our-data.html#cb9-23"></a>  <span class="co"># get the product information</span></span>
<span id="cb9-24"><a href="web-scraping-our-data.html#cb9-24"></a>  product &lt;-<span class="st">  </span>json_parsed<span class="op">$</span>BatchedResults<span class="op">$</span>q0<span class="op">$</span>Results[[<span class="dv">1</span>]]</span>
<span id="cb9-25"><a href="web-scraping-our-data.html#cb9-25"></a>  product_name &lt;-<span class="st"> </span>product<span class="op">$</span>Name</span>
<span id="cb9-26"><a href="web-scraping-our-data.html#cb9-26"></a>  product_brand &lt;-<span class="st"> </span>product<span class="op">$</span>Brand<span class="op">$</span>Name</span>
<span id="cb9-27"><a href="web-scraping-our-data.html#cb9-27"></a>  </span>
<span id="cb9-28"><a href="web-scraping-our-data.html#cb9-28"></a>  </span>
<span id="cb9-29"><a href="web-scraping-our-data.html#cb9-29"></a>  reviews &lt;-<span class="st"> </span>json_parsed<span class="op">$</span>BatchedResults<span class="op">$</span>q2<span class="op">$</span>Results</span>
<span id="cb9-30"><a href="web-scraping-our-data.html#cb9-30"></a>  </span>
<span id="cb9-31"><a href="web-scraping-our-data.html#cb9-31"></a>  <span class="co"># use purrr::map to apply get_review() to each individual review</span></span>
<span id="cb9-32"><a href="web-scraping-our-data.html#cb9-32"></a>  reviews1 &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb9-33"><a href="web-scraping-our-data.html#cb9-33"></a>    <span class="dt">x =</span> purrr<span class="op">::</span><span class="kw">map</span>(reviews, get_review)</span>
<span id="cb9-34"><a href="web-scraping-our-data.html#cb9-34"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb9-35"><a href="web-scraping-our-data.html#cb9-35"></a><span class="st">    </span><span class="kw">unnest</span>(<span class="dt">cols =</span> <span class="st">&quot;x&quot;</span>)</span>
<span id="cb9-36"><a href="web-scraping-our-data.html#cb9-36"></a>  </span>
<span id="cb9-37"><a href="web-scraping-our-data.html#cb9-37"></a>  <span class="kw">message</span> (<span class="st">&quot;   First API call done and processed.&quot;</span>)</span>
<span id="cb9-38"><a href="web-scraping-our-data.html#cb9-38"></a>  </span>
<span id="cb9-39"><a href="web-scraping-our-data.html#cb9-39"></a>  <span class="co">####################################3</span></span>
<span id="cb9-40"><a href="web-scraping-our-data.html#cb9-40"></a>  <span class="co"># SECOND API CALL. Try to load additional reviews:</span></span>
<span id="cb9-41"><a href="web-scraping-our-data.html#cb9-41"></a>  api_url &lt;-<span class="st">  </span><span class="kw">get_second_api_url</span>(product_id)</span>
<span id="cb9-42"><a href="web-scraping-our-data.html#cb9-42"></a>  <span class="co"># test &lt;- read_html(api_url)</span></span>
<span id="cb9-43"><a href="web-scraping-our-data.html#cb9-43"></a>  <span class="co"># text &lt;- test %&gt;% html_text() </span></span>
<span id="cb9-44"><a href="web-scraping-our-data.html#cb9-44"></a>  text &lt;-<span class="st"> </span><span class="kw">GET</span>(api_url) <span class="op">%&gt;%</span></span>
<span id="cb9-45"><a href="web-scraping-our-data.html#cb9-45"></a><span class="st">    </span><span class="kw">content</span>(<span class="st">&quot;text&quot;</span>)</span>
<span id="cb9-46"><a href="web-scraping-our-data.html#cb9-46"></a>  </span>
<span id="cb9-47"><a href="web-scraping-our-data.html#cb9-47"></a>  json_parsed &lt;-<span class="st"> </span>text <span class="op">%&gt;%</span></span>
<span id="cb9-48"><a href="web-scraping-our-data.html#cb9-48"></a><span class="st">    </span><span class="kw">str_extract</span>(<span class="st">&quot;(?&lt;=</span><span class="ch">\\</span><span class="st">()(.*)(?=</span><span class="ch">\\</span><span class="st">))&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb9-49"><a href="web-scraping-our-data.html#cb9-49"></a><span class="st">    </span>jsonlite<span class="op">::</span><span class="kw">fromJSON</span>()</span>
<span id="cb9-50"><a href="web-scraping-our-data.html#cb9-50"></a>  </span>
<span id="cb9-51"><a href="web-scraping-our-data.html#cb9-51"></a>  json_results &lt;-<span class="st"> </span>json_parsed<span class="op">$</span>BatchedResults<span class="op">$</span>q0<span class="op">$</span>Results </span>
<span id="cb9-52"><a href="web-scraping-our-data.html#cb9-52"></a>  </span>
<span id="cb9-53"><a href="web-scraping-our-data.html#cb9-53"></a>  </span>
<span id="cb9-54"><a href="web-scraping-our-data.html#cb9-54"></a>  <span class="co"># set our second set of reviews to NULL in case we don&#39;t find any</span></span>
<span id="cb9-55"><a href="web-scraping-our-data.html#cb9-55"></a>  reviews2 &lt;-<span class="st"> </span><span class="ot">NULL</span></span>
<span id="cb9-56"><a href="web-scraping-our-data.html#cb9-56"></a>  </span>
<span id="cb9-57"><a href="web-scraping-our-data.html#cb9-57"></a>  <span class="co"># if we do find some, set them to that!</span></span>
<span id="cb9-58"><a href="web-scraping-our-data.html#cb9-58"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.null</span>(json_results) <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(json_results)<span class="op">&gt;</span><span class="dv">0</span>) {</span>
<span id="cb9-59"><a href="web-scraping-our-data.html#cb9-59"></a>    <span class="cf">if</span> (<span class="kw">any</span>(<span class="kw">str_detect</span>(<span class="kw">names</span>(json_results), <span class="st">&quot;SubmissionTime&quot;</span>))){</span>
<span id="cb9-60"><a href="web-scraping-our-data.html#cb9-60"></a>      reviews2 &lt;-<span class="st">   </span>json_results <span class="op">%&gt;%</span></span>
<span id="cb9-61"><a href="web-scraping-our-data.html#cb9-61"></a><span class="st">        </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb9-62"><a href="web-scraping-our-data.html#cb9-62"></a><span class="st">        </span><span class="kw">select</span>(<span class="dt">review_date =</span> SubmissionTime,</span>
<span id="cb9-63"><a href="web-scraping-our-data.html#cb9-63"></a>               <span class="dt">user_name =</span> UserNickname,</span>
<span id="cb9-64"><a href="web-scraping-our-data.html#cb9-64"></a>               <span class="dt">review_title =</span> Title,</span>
<span id="cb9-65"><a href="web-scraping-our-data.html#cb9-65"></a>               <span class="dt">review_text =</span> ReviewText,</span>
<span id="cb9-66"><a href="web-scraping-our-data.html#cb9-66"></a>               <span class="dt">rating_num =</span> Rating</span>
<span id="cb9-67"><a href="web-scraping-our-data.html#cb9-67"></a>        ) <span class="op">%&gt;%</span></span>
<span id="cb9-68"><a href="web-scraping-our-data.html#cb9-68"></a><span class="st">        </span><span class="kw">mutate</span>(<span class="dt">product_id =</span> product_code)</span>
<span id="cb9-69"><a href="web-scraping-our-data.html#cb9-69"></a>    }</span>
<span id="cb9-70"><a href="web-scraping-our-data.html#cb9-70"></a>  }</span>
<span id="cb9-71"><a href="web-scraping-our-data.html#cb9-71"></a>  </span>
<span id="cb9-72"><a href="web-scraping-our-data.html#cb9-72"></a>  <span class="kw">message</span> (<span class="st">&quot;    Second API call done and processed.&quot;</span>)</span>
<span id="cb9-73"><a href="web-scraping-our-data.html#cb9-73"></a>  </span>
<span id="cb9-74"><a href="web-scraping-our-data.html#cb9-74"></a>  <span class="co"># put the new reviews together:</span></span>
<span id="cb9-75"><a href="web-scraping-our-data.html#cb9-75"></a>  new_reviews &lt;-<span class="st">  </span><span class="kw">bind_rows</span>(reviews1, reviews2) <span class="op">%&gt;%</span></span>
<span id="cb9-76"><a href="web-scraping-our-data.html#cb9-76"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">product_name =</span> product_name,</span>
<span id="cb9-77"><a href="web-scraping-our-data.html#cb9-77"></a>           <span class="dt">product_brand=</span> product_brand)</span>
<span id="cb9-78"><a href="web-scraping-our-data.html#cb9-78"></a>  </span>
<span id="cb9-79"><a href="web-scraping-our-data.html#cb9-79"></a>  all_reviews &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(all_reviews, new_reviews)</span>
<span id="cb9-80"><a href="web-scraping-our-data.html#cb9-80"></a>} <span class="co"># end (for i)</span></span>
<span id="cb9-81"><a href="web-scraping-our-data.html#cb9-81"></a></span>
<span id="cb9-82"><a href="web-scraping-our-data.html#cb9-82"></a>all_reviews <span class="op">%&gt;%</span></span>
<span id="cb9-83"><a href="web-scraping-our-data.html#cb9-83"></a><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></span>
<span id="cb9-84"><a href="web-scraping-our-data.html#cb9-84"></a><span class="st">  </span><span class="kw">write_csv</span>(<span class="kw">paste0</span>(<span class="st">&quot;reviews-&quot;</span>,product_type,<span class="st">&quot;.csv&quot;</span>))</span></code></pre></div>
</div>
</div>
<div id="summary" class="section level2">
<h2><span class="header-section-number">3.6</span> Summary</h2>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-bruell_fraudulent_2018">
<p>Bruell, Alexandra. 2018. “Fraudulent Web Traffic Continues to Plague Advertisers, Other Businesses.” <em>Wall Street Journal</em>, March. <a href="https://www.wsj.com/articles/fraudulent-web-traffic-continues-to-plague-advertisers-other-businesses-1522234801">https://www.wsj.com/articles/fraudulent-web-traffic-continues-to-plague-advertisers-other-businesses-1522234801</a>.</p>
</div>
<div id="ref-goodreads_about_2020">
<p>Goodreads. 2020. “About Goodreads.” <a href="https://www.goodreads.com/about/us">https://www.goodreads.com/about/us</a>.</p>
</div>
<div id="ref-google_how_2020">
<p>Google. 2020. “How Google’s Site Crawlers Index Your Site - Google Search.” <a href="https://www.google.com/search/howsearchworks/crawling-indexing/">https://www.google.com/search/howsearchworks/crawling-indexing/</a>.</p>
</div>
<div id="ref-lafrance_internet_2017">
<p>LaFrance, Adrienne. 2017. “The Internet Is Mostly Bots.” <em>The Atlantic</em>. <a href="https://www.theatlantic.com/technology/archive/2017/01/bots-bots-bots/515043/">https://www.theatlantic.com/technology/archive/2017/01/bots-bots-bots/515043/</a>.</p>
</div>
<div id="ref-wickham_package_2020">
<p>Wickham, Hadley. 2020. “Package ‘Rvest’.” <a href="https://cran.r-project.org/web/packages/rvest/rvest.pdf">https://cran.r-project.org/web/packages/rvest/rvest.pdf</a>.</p>
</div>
<div id="ref-yelp_about_2020">
<p>Yelp. 2020. “About Us.” <em>Yelp</em>. <a href="https://www.yelp.ca/about">https://www.yelp.ca/about</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data-summary-eda-initial-model-attempts.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/02-web-scraping.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["telfer-mba-nlp.pdf", "telfer-mba-nlp.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
